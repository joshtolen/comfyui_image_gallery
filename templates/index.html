<!DOCTYPE html>
<html>
<head>
    <title>ComfyUI Output Images</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">
</head>
<body class="dark-mode">
    <header>
        <div class="logo-container">
            <img class="logo" src="{{ url_for('static', filename='logo.png') }}" alt="ComfyUI Logo">
        </div>
    </header>
    <button id="delete-selected" class="delete-button">Delete Selected</button>
    <ul class="image-list">
        {% for img, thumbnail in current_thumbnails %}
            <li>
                <div class="thumbnail">
                    <!-- Checkbox -->
                    <input type="checkbox" class="file-checkbox" data-filename="{{ img }}">

                    <!-- Trash icon -->
                    <div class="trash-icon" data-filename="{{ img }}">
                        &#128465; <!-- Unicode for trash can -->
                    </div>

                    <!-- Information button -->
                    <div class="info-icon" data-filename="{{ img }}" data-type="image/jpeg" data-size="123 KB">
                        &#9432; <!-- Unicode for "information" icon -->
                    </div>

                    <div class="download-icon" data-download-url="{{ url_for('static', filename='images/output/' + img) }}">
                        &#8681; <!-- Unicode for download arrow -->
                    </div>

                    <!-- Thumbnail image -->
                    <a data-fancybox="gallery" href="{{ url_for('static', filename='images/output/' + img) }}">
                        <img src="{{ url_for('static', filename='thumbnails/' + thumbnail) }}" alt="{{ thumbnail }}">
                    </a>
                </div>
            </li>
        {% endfor %}
    </ul>
    <div class="pagination">
        {% if page > 1 %}
            <a href="?page=1">&laquo; First</a>
            <a href="?page={{ page - 1 }}">Previous</a>
        {% endif %}
        {% for p in range(1, total_pages + 1) %}
            <a href="?page={{ p }}" {% if p == page %}class="current-page"{% endif %}>{{ p }}</a>
        {% endfor %}
        {% if page < total_pages %}
            <a href="?page={{ page + 1 }}">Next</a>
            <a href="?page={{ total_pages }}">Last &raquo;</a>
        {% endif %}
    </div>
    <div id="info-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <!-- Close button -->
            <span class="close-modal">&times;</span>
            <h2>File Information</h2>
            <p><strong>Filename:</strong> <span id="file-name"></span></p>
            <p><strong>Type:</strong> <span id="file-type"></span></p>
            <p><strong>Size:</strong> <span id="file-size"></span></p>
        </div>
    </div>
    <footer class="footer">
    All images are copyrighted &#169; 2023
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
</body>
    <script>
        $(document).ready(function () {
            // Info button click event
            $('.info-icon').click(function () {
                // Get file details from the data attributes
                const fileName = $(this).data('filename');
                const fileType = $(this).data('type');
                const fileSize = $(this).data('size');

                // Populate the modal with details
                $('#file-name').text(fileName);
                $('#file-type').text(fileType);
                $('#file-size').text(fileSize);

                // Show the modal
                $('#info-modal').fadeIn();
            });

            // Close button logic
            $('.close-modal').click(function () {
                $('#info-modal').fadeOut();
            });

            // Close modal when clicking outside the modal content
            $(window).click(function (event) {
                if ($(event.target).closest('.modal-content').length === 0 && $(event.target).is('.modal')) {
                    $('#info-modal').fadeOut();
                }
            });
        });
        $(document).ready(function () {
            // Handle click on the download icon
            $('.download-icon').click(function () {
                // Get the download URL from the data attribute
                const downloadUrl = $(this).data('download-url');

                // Create a temporary anchor element to download the file
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = ''; // Suggests to download with its original name from the server
                document.body.appendChild(link); // Append the link temporarily
                link.click(); // Trigger the download
                document.body.removeChild(link); // Remove the link afterward
            });
        });
        $(document).ready(function () {
            // Functionality for "Delete Selected" button
            $('#delete-selected').click(function () {
                const selectedFiles = [];
                $('.file-checkbox:checked').each(function () {
                    selectedFiles.push($(this).data('filename'));
                });

                if (selectedFiles.length === 0) {
                    alert('Please select at least one file to delete.');
                    return;
                }

                if (!confirm('Are you sure you want to delete the selected files?')) {
                    return;
                }

                $.ajax({
                    url: '/delete-files',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ files: selectedFiles }),
                    success: function (response) {
                        alert(response.message);
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        alert('An error occurred: ' + xhr.responseText);
                    }
                });
            });

            // Functionality for individual trash icons
            $('.trash-icon').click(function () {
                const filename = $(this).data('filename');
                if (!confirm('Are you sure you want to delete this file?')) {
                    return;
                }

                $.ajax({
                    url: '/delete-file',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ file: filename }),
                    success: function (response) {
                        alert(response.message);
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        alert('An error occurred: ' + xhr.responseText);
                    }
                });
            });
        });
    </script>
</html>
